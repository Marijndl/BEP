import os
from math import pi

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

eps0 = 8.8542e-12

baseline_1 = [0.12883378816993937, 0.14426108072435476, 0.17683227026476922, 0.2192957112691608, 0.24192813494600623, 0.2370253859361344, 0.2077060764297643, 0.1742043708039368, 0.15399783356579955, 0.1599722162618556, 0.1939770629352958, 0.22843311764352842, 0.25708844675213616, 0.2632354517786475, 0.23636392569421646, 0.19891431527087852, 0.17020394885152293, 0.1598966839088764, 0.188729269541799, 0.232564137075959, 0.2689682778151796, 0.2832963763036024, 0.27003813682208255, 0.23981739594278198, 0.19849211962621544, 0.1883728872385032, 0.19869468341087515, 0.2291451423368147, 0.27077809463345887, 0.29551194998300384, 0.29681869807602357, 0.26954441993341116, 0.2452319257398391, 0.2260622462625363, 0.22575747986635852, 0.25213972854195005, 0.28370824097828073, 0.3061920255296273, 0.31480564560618657, 0.299584571896894, 0.2674593831818452, 0.24883715610160487, 0.24940849156498096, 0.27092217745070923, 0.30579017471923137, 0.3390767324709508, 0.3452086944480067, 0.3358056035644525, 0.303040562301304, 0.27083009996863233, 0.26568798622286277, 0.28190696932418907, 0.31670993767071265, 0.35542785963799967, 0.37591739424401627, 0.3666013127145605, 0.3519539332900083, 0.3143319453195642, 0.2883376559993057, 0.2901506995071872, 0.3107076218565667, 0.34896624681202415, 0.37544851173876537, 0.3921429698059952, 0.3767094575292088, 0.3589758385123596, 0.3368318688821793, 0.3234235994606769, 0.34344217090297513, 0.3690793491331483, 0.3977386726609532, 0.4079836235514734, 0.4060532731867812, 0.38163988374730573, 0.35550838779660415, 0.35585740990965237, 0.3630931055711756, 0.4011335061708872, 0.42839667448740404, 0.4449858367717041, 0.4478565334985799, 0.4171907486742784, 0.38550783896503693, 0.3600772523182681, 0.3650974917724624, 0.3881410513371969, 0.43267038035934335, 0.4709974445139133, 0.48203110960834933, 0.47350798704861347, 0.4348695250944077, 0.40502956696770437, 0.38104922152586457, 0.3995917493729326, 0.4232406971028613, 0.4654828261433533, 0.49671474478486183, 0.4943432725720128, 0.48150002431613065, 0.4503103919981837, 0.4353026803572021]
baseline_2 = [0.17617760366389762, 0.17871716623749834, 0.1812641079267555, 0.18381842873166915, 0.1863801286522393, 0.18894920768846593, 0.191525665840349, 0.1941095031078886, 0.19670071949108467, 0.19929931498993722, 0.20190528960444626, 0.20451864333461173, 0.20713937618043374, 0.2097674881419122, 0.21240297921904713, 0.21504584941183857, 0.2176960987202865, 0.22035372714439086, 0.22301873468415176, 0.2256911213395691, 0.22837088711064293, 0.23105803199737326, 0.23375255599976005, 0.23645445911780333, 0.2391637413515031, 0.2418804027008593, 0.24460444316587207, 0.24733586274654124, 0.2500746614428669, 0.2528208392548491, 0.25557439618248773, 0.2583353322257828, 0.26110364738473446, 0.2638793416593425, 0.26666241504960714, 0.26945286755552816, 0.27225069917710565, 0.2750559099143397, 0.2778684997672302, 0.2806884687357772, 0.2835158168199806, 0.28635054401984056, 0.28919265033535696, 0.2920421357665299, 0.2948990003133592, 0.29776324397584514, 0.30063486675398743, 0.30351386864778623, 0.3064002496572415, 0.30929400978235333, 0.3121951490231216, 0.3151036673795463, 0.3180195648516275, 0.32094284143936525, 0.3238734971427594, 0.3268115319618101, 0.3297569458965173, 0.3327097389468809, 0.33566991111290095, 0.3386374623945776, 0.34161239279191064, 0.34459470230490025, 0.34758439093354626, 0.35058145867784873, 0.3535859055378077, 0.3565977315134232, 0.35961693660469524, 0.36264352081162365, 0.36567748413420853, 0.3687188265724499, 0.3717675481263478, 0.37482364879590213, 0.37788712858111306, 0.38095798748198034, 0.38403622549850414, 0.3871218426306844, 0.3902148388785212, 0.3933152142420145, 0.39642296872116417, 0.39953810231597037, 0.402660615026433, 0.40579050685255225, 0.4089277777943279, 0.41207242785176, 0.4152244570248486, 0.4183838653135937, 0.42155065271799524, 0.42472481923805333, 0.42790636487376793, 0.4310952896251389, 0.4342915934921664, 0.4374952764748503, 0.44070633857319075, 0.4439247797871878, 0.4471506001168412, 0.4503837995621511, 0.45362437812311746, 0.4568723357997403, 0.46012767259201975, 0.46339038849995556, 0.46666048352354783]

remove_baseline = True

def read_file(file):
    '''
            Function to read .prn files that are outputted by the VNA.
            Will return a list of the frequencies and a list of the corresponding conductivities.
            Conductivity is calculated with: e'' * eps0 * 2pi * frequency
    '''
    freq = []
    e1 = []
    e2 = []
    cond = []

    with open(f'' + file) as data_file:
        data_file = data_file.readlines()
        for i in range(1, len(data_file)):
            result = data_file[i].split()
            freq.append(int(float(result[0]) / 1e6))
            e1.append(float(result[1]))
            e2.append(float(result[2]))
            cond.append(float(result[2]) * eps0 * 2 * pi * float(result[0]))
    if remove_baseline:
        cond = list(np.subtract(np.array(cond),np.array(baseline_2)))
    return freq, cond


if __name__ == "__main__":
    # assign directory
    directory = 'C:\\Users\\lolwi\\Documents\\GitHub\\BEP_VNA_data\\Misc'
    file_names = []
    dicts = {}
    # iterate over files in that directory
    for filename in os.listdir(directory):
        f = os.path.join(directory, filename)
        # checking if it is a file
        if os.path.isfile(f):
            file_names.append(filename)
            print(filename)
            parts = filename.replace('.', '_').split('_')
            freq, cond = read_file(f)

            if len(parts) > 3:
                sample = parts[0] + " " + parts[1]
            else:
                sample = parts[0]

            if sample not in dicts:
                dicts[sample] = {'Frequency': freq, parts[-2][1:]: cond}
            else:
                dicts[sample][parts[-2][1:]] = cond

    # Plotting:
    fig = plt.figure(figsize=(30, 20))
    counter = 1

    for name, dict_ in dicts.items():
        df = pd.DataFrame(dict_).set_index('Frequency')
        ax = plt.subplot(2, 3, counter)  # give the plot the right place in the figure

        # subplot formatting
        ax.title.set_text("Sample " + str(name))
        for column in df.columns:
            ax.plot(df[column])
            print(column)

        # Fitting a line to the mean:
        if name == 'baseline':
            print(df.mean(axis=1).to_list())
        coeff = np.polyfit(df.index, df.mean(axis=1), 2)
        coeff = np.flip(coeff)

        # Make the fitting work for all orders
        y_fit = [0] * len(df.index)
        for order in range(len(coeff)):
            y_fit = y_fit + coeff[order] * (df.index ** order)
        ax.plot(df.index, y_fit)

        if name == 'baseline':
            print(list(y_fit))

        #Finding conductivities at 128 Mhz
        cond_128 = np.interp(128, df.index, y_fit)
        print(name+" has at 128 Mhz the cond: "+str(cond_128))

        plt.xlabel('Frequency [Mhz]')
        plt.ylabel('Conductivity [S/m]')
        plt.legend(list(df.columns)+['mean fitted'])

        counter += 1

    fig.show()
    #fig.savefig('Misc2.png')
    pass
